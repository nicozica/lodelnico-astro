---
// Photo detail page with title, date, image and content
import BaseLayout from '../../layouts/BaseLayout.astro';
import type { PhotoItem } from '../../types/photoblog';
import he from 'he';

interface Props {
  photo: PhotoItem;
  prevPhoto: PhotoItem | null;
  nextPhoto: PhotoItem | null;
  fromPage: number;
}

// Format date in Spanish
function formatDateInSpanish(dateString: string): string {
  const date = new Date(dateString);
  const months = [
    'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
    'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
  ];
  
  const day = date.getDate();
  const month = months[date.getMonth()];
  const year = date.getFullYear();
  
  return `${day} de ${month} de ${year}`;
}

// Generate static paths for all photos
export async function getStaticPaths() {
  // Import the photoblog data generated at build time
  const photoblogData = await import('../../data/photoblog.json');
  const photos = photoblogData.default as PhotoItem[];
  
  // Photos are already sorted by date DESC from the API
  return photos.map((photo, index) => {
    const prevPhoto = index > 0 ? photos[index - 1] : null;
    const nextPhoto = index < photos.length - 1 ? photos[index + 1] : null;
    
    return {
      params: { id: photo.id.toString() },
      props: {
        photo,
        prevPhoto,
        nextPhoto,
        fromPage: 1 // Default fallback
      } satisfies Props
    };
  });
}

// Get props from getStaticPaths and URL params
const { photo, prevPhoto, nextPhoto, fromPage: defaultFromPage } = Astro.props as Props;

// Get the 'from' parameter from URL query string (client-side will handle this)
// For now, we'll use the default or calculate based on photo position
const photoblogData = await import('../../data/photoblog.json');
const allPhotos = photoblogData.default as PhotoItem[];
const photoIndex = allPhotos.findIndex(p => p.id === photo.id);
const calculatedFromPage = Math.ceil((photoIndex + 1) / 9); // 9 photos per page

// Format publication date
const formattedDate = formatDateInSpanish(photo.date);
const decodedTitle = he.decode(photo.title);
---

<BaseLayout 
  title={`${decodedTitle} - Lo del Nico`}
  description={`Photo: ${decodedTitle}`}
  showHero={false}
>
  <div class="photo-detail">
    <div class="content-container">
      <!-- Header with title and date (date just below title) -->
      <div class="content">
        <header class="photo-header">
          <h1 class="photo-title">{decodedTitle}</h1>
          <div class="photo-date">{formattedDate}</div>
        </header>
      </div>

      <!-- Image section with wider container and navigation arrows -->
      <div class="image-section">
        <!-- Previous photo arrow -->
        {prevPhoto && (
          <a 
            href={`/photo/${prevPhoto.id}/`} 
            class="nav-arrow arrow nav-prev"
            aria-label={`Previous photo: ${prevPhoto.title}`}
          >
            ←
          </a>
        )}

        <!-- Main image with wider container -->
        <div class="image-wide">
          <img 
            src={photo.image} 
            alt={decodedTitle}
            width="1200"
            height="800"
          />
        </div>

        <!-- Next photo arrow -->
        {nextPhoto && (
          <a 
            href={`/photo/${nextPhoto.id}/`} 
            class="nav-arrow arrow nav-next"
            aria-label={`Next photo: ${nextPhoto.title}`}
          >
            →
          </a>
        )}
      </div>

      <!-- Back to gallery link - centered just below the image -->
      <div class="photo-back">
        <a 
          href={`/${calculatedFromPage}/`} 
          id="back-link"
        >
          ← Back to gallery
        </a>
      </div>

      <!-- Content section with narrow text container -->
      {photo.contentHtmlNoImg && photo.contentHtmlNoImg.trim() && (
        <section class="content photo-content" style="margin-top: 40px;">
          <div class="prose" set:html={photo.contentHtmlNoImg} />
        </section>
      )}
    </div>
  </div>
</BaseLayout>

<!-- Client-side script to handle 'from' parameter -->
<script>
  // Update back link based on 'from' URL parameter
  const urlParams = new URLSearchParams(window.location.search);
  const fromPage = urlParams.get('from');
  
  if (fromPage && /^\d+$/.test(fromPage)) {
    const backLink = document.getElementById('back-link');
    if (backLink && backLink instanceof HTMLAnchorElement) {
      backLink.href = `/${fromPage}/`;
    }
  }
</script>
